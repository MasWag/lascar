#!/bin/bash

configure_options="$*"
libdir=`opam config var lib`
docdir=`opam config var doc`
native='yes'
debug=''
dotviewer='graphviz'

ocamlversion_min=4.03

# Parse command-line arguments

while : ; do
  case "$1" in
    "") break;;
    -libdir|--libdir)
        libdir=$2; shift;;
    -docdir|--docdir)
        docdir=$2; shift;;
    -byte-only|--byte-only)
        native='no'; shift;;
    -debug|--debug)
        debug='-g'; shift; continue;;
    -dotviewer|--dotviewer)
        dotviewer=$2; shift;;
    -help|--help)
        cat <<EOF
Usage: configure [options]
Options: [defaults in brackets after descriptions]
  --libdir DIR         install library in DIR [default: $libdir]
  --docdir DIR         install documentation in DIR [default: $docdir]
  --byte-only             do not build native code executable
  --debug                 compile in debug mode [default: no]
  --dotviewer NAME        command name for displaying .dot files [default: open -a Graphviz]
  --help                  print this message
EOF
	exit 0;;
    *) echo "Unknown option \"$1\"." 1>&2; exit 2;;
  esac
  shift
done

# Generate the config file

rootdir=`dirname $0`

cd $rootdir
rm -f config
touch config

# Write options

version=`cat VERSION`
echo "# generated by ./configure $configure_options" >> config
echo "" >> config
echo "VERSION=$version" >> config

# Where to install

echo "# Where to install" >> config
echo "LIBDIR=$libdir" >> config
echo "DOCDIR=$docdir" >> config

# checking for dot viewer 
set dummy $dotviewer; pgm_name=$2
/bin/echo -n "checking for program to view .dot files... "
if command -v "$pgm_name" >/dev/null 2>&1; then
   echo "$pgm_name"
   dotviewer=$pgm_name
else
   echo "not found"
   { echo "** configure: warning: cannot find $pgm_name." 1>&2; }
   dotviewer=''
fi

# Finish generated files

if [ -n "$dotviewer" ]; then
echo "DOTVIEWER=$dotviewer" >> config
fi
echo "CAMLCFLAGS=$debug" >> config
echo "CAMLOPTFLAGS=$debug" >> config
echo "LINKFLAGS=$debug" >> config
touch ./config-stamp

echo >> config
echo "BUILD_NATIVE=$native" >> config
echo "" >> config

echo
echo "** Configuration summary **"
echo
echo "Directory where the distribution will be installed:"
echo "        library.................   $libdir"
echo "        documentation............. $docdir"
if [ -n "$dotviewer" ]; then
echo "Program for viewing .dot files: \"$dotviewer\""
fi
echo
echo "** Configuration completed successfully **"
echo "** Wrote files ./config"
echo
